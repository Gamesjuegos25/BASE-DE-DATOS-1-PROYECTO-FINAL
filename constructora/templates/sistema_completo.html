{% extends "base.html" %}

{% block title %}Sistema Completo - ERP Constructora{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4 text-center mb-4">
                <i class="fas fa-building"></i> Sistema ERP Constructora Completo
            </h1>
            <p class="text-center text-muted">86 Tablas - 8 Módulos Integrados</p>
        </div>
    </div>

    <!-- Métricas Generales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ dashboard.finanzas.total_facturas or 0 }}</h4>
                            <p>Facturas Emitidas</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-invoice fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ dashboard.obras.obras_activas or 0 }}</h4>
                            <p>Obras Activas</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-hammer fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ dashboard.mantenimiento.programados or 0 }}</h4>
                            <p>Mantenimientos Programados</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-wrench fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ dashboard.alertas_pendientes or 0 }}</h4>
                            <p>Alertas Pendientes</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Módulos del Sistema -->
    <div class="row">
        <!-- Módulo Comercial -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-handshake"></i> Módulo Comercial</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Clientes:</strong> {{ dashboard.modulos.comercial.clientes if dashboard.modulos else 0 }}</p>
                            <p><strong>Obras:</strong> {{ dashboard.modulos.comercial.obras if dashboard.modulos else 0 }}</p>
                        </div>
                        <div class="col-6">
                            <a href="/clientes" class="btn btn-outline-primary btn-sm mb-1">Ver Clientes</a><br>
                            <a href="/obras" class="btn btn-outline-primary btn-sm">Ver Obras</a>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Gestión de clientes y proyectos</small>
                </div>
            </div>
        </div>

        <!-- Módulo Facturación -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-file-invoice-dollar"></i> Módulo Facturación</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Facturación Total:</strong> {{ format_currency(dashboard.finanzas.facturacion_total) if dashboard.finanzas else '$0.00' }}</p>
                            <p><strong>Por Cobrar:</strong> {{ format_currency(dashboard.finanzas.pendiente_cobro) if dashboard.finanzas else '$0.00' }}</p>
                        </div>
                        <div class="col-6">
                            <a href="/facturas" class="btn btn-outline-success btn-sm mb-1">Ver Facturas</a><br>
                            <a href="/pagos" class="btn btn-outline-success btn-sm mb-1">Ver Pagos</a><br>
                            <a href="/cuentas-por-cobrar" class="btn btn-outline-success btn-sm">Cuentas por Cobrar</a>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Facturación y cobranzas</small>
                </div>
            </div>
        </div>

        <!-- Módulo Contabilidad -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-calculator"></i> Módulo Contabilidad</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <a href="/contabilidad" class="btn btn-outline-warning btn-sm mb-1">Dashboard Contable</a><br>
                            <a href="/contabilidad/cuentas" class="btn btn-outline-warning btn-sm mb-1">Cuentas Contables</a><br>
                            <a href="/contabilidad/flujo-caja" class="btn btn-outline-warning btn-sm mb-1">Flujo de Caja</a><br>
                            <a href="/contabilidad/gastos-obra" class="btn btn-outline-warning btn-sm">Gastos por Obra</a>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Control contable y financiero</small>
                </div>
            </div>
        </div>

        <!-- Módulo RRHH -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-users"></i> Módulo RRHH</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Empleados:</strong> {{ dashboard.modulos.rrhh.empleados if dashboard.modulos else 0 }}</p>
                        </div>
                        <div class="col-6">
                            <a href="/empleados" class="btn btn-outline-info btn-sm mb-1">Ver Empleados</a><br>
                            <a href="/nomina" class="btn btn-outline-info btn-sm mb-1">Nómina</a><br>
                            <a href="/nomina/asistencia" class="btn btn-outline-info btn-sm mb-1">Asistencia</a><br>
                            <a href="/nomina/capacitaciones" class="btn btn-outline-info btn-sm">Capacitaciones</a>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Gestión de recursos humanos</small>
                </div>
            </div>
        </div>

        <!-- Módulo Activos -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <h5><i class="fas fa-tools"></i> Módulo Activos</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Equipos:</strong> {{ dashboard.modulos.activos.equipos if dashboard.modulos else 0 }}</p>
                            <p><strong>Vehículos:</strong> {{ dashboard.modulos.activos.vehiculos if dashboard.modulos else 0 }}</p>
                        </div>
                        <div class="col-6">
                            <a href="/equipos" class="btn btn-outline-secondary btn-sm mb-1">Ver Equipos</a><br>
                            <a href="/vehiculos" class="btn btn-outline-secondary btn-sm">Ver Vehículos</a>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Control de activos fijos</small>
                </div>
            </div>
        </div>

        <!-- Módulo Mantenimiento -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5><i class="fas fa-wrench"></i> Módulo Mantenimiento</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <a href="/mantenimiento" class="btn btn-outline-danger btn-sm mb-1">Dashboard</a><br>
                            <a href="/mantenimiento/mantenimientos" class="btn btn-outline-danger btn-sm mb-1">Mantenimientos</a><br>
                            <a href="/mantenimiento/repuestos" class="btn btn-outline-danger btn-sm">Repuestos</a>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Mantenimiento preventivo y correctivo</small>
                </div>
            </div>
        </div>

        <!-- Módulo Inventarios -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-boxes"></i> Módulo Inventarios</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Materiales:</strong> {{ dashboard.modulos.inventarios.materiales if dashboard.modulos else 0 }}</p>
                            <p><strong>Bodegas:</strong> {{ dashboard.modulos.inventarios.bodegas if dashboard.modulos else 0 }}</p>
                        </div>
                        <div class="col-6">
                            <a href="/materiales" class="btn btn-outline-dark btn-sm mb-1">Ver Materiales</a><br>
                            <a href="/bodegas" class="btn btn-outline-dark btn-sm mb-1">Ver Bodegas</a><br>
                            <a href="/compras/ordenes" class="btn btn-outline-dark btn-sm">Órdenes de Compra</a>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Control de inventarios y compras</small>
                </div>
            </div>
        </div>

        <!-- Módulo Reportes -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light text-dark">
                    <h5><i class="fas fa-chart-bar"></i> Módulo Reportes</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <a href="/reportes" class="btn btn-outline-dark btn-sm mb-1">Reportes Generales</a><br>
                            <a href="/reportes/kpi" class="btn btn-outline-dark btn-sm mb-1">Métricas KPI</a><br>
                            <a href="/reportes/completos" class="btn btn-outline-dark btn-sm mb-1">Reportes Completos</a><br>
                            <a href="/alertas" class="btn btn-outline-dark btn-sm">Alertas del Sistema</a>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Reportes y análisis avanzados</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Búsqueda Global -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-search"></i> Búsqueda Global</h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" id="busqueda-global" placeholder="Buscar en todo el sistema...">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="button" onclick="buscarGlobal()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                    <div id="resultados-busqueda" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estado del Sistema -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-server"></i> Estado del Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Base de Datos</h6>
                            <span class="badge badge-success">86 Tablas Activas</span>
                        </div>
                        <div class="col-md-4">
                            <h6>Módulos</h6>
                            <span class="badge badge-success">8 Módulos Operativos</span>
                        </div>
                        <div class="col-md-4">
                            <h6>Conexión</h6>
                            <span class="badge badge-success">PostgreSQL Conectado</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function buscarGlobal() {
    const termino = document.getElementById('busqueda-global').value;
    const resultadosDiv = document.getElementById('resultados-busqueda');
    
    if (!termino.trim()) {
        resultadosDiv.innerHTML = '<div class="alert alert-warning">Por favor ingrese un término de búsqueda</div>';
        return;
    }
    
    fetch(`/api/buscar?q=${encodeURIComponent(termino)}`)
        .then(response => response.json())
        .then(data => {
            if (data.resultados && data.resultados.length > 0) {
                let html = '<h6>Resultados encontrados:</h6><ul class="list-group">';
                data.resultados.forEach(resultado => {
                    html += `<li class="list-group-item">
                        <strong>${resultado.tipo}:</strong> ${resultado.nombre} 
                        ${resultado.detalle ? `<small class="text-muted">(${resultado.detalle})</small>` : ''}
                    </li>`;
                });
                html += '</ul>';
                resultadosDiv.innerHTML = html;
            } else {
                resultadosDiv.innerHTML = '<div class="alert alert-info">No se encontraron resultados</div>';
            }
        })
        .catch(error => {
            resultadosDiv.innerHTML = '<div class="alert alert-danger">Error en la búsqueda</div>';
        });
}

// Buscar al presionar Enter
document.getElementById('busqueda-global').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        buscarGlobal();
    }
});
</script>
{% endblock %}